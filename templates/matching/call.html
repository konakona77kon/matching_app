{% extends "matching/base.html" %}

{% block title %}é€šè©±ãƒ«ãƒ¼ãƒ  | melo-match{% endblock %}

{% block extra_css %}
<style>
  /* ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ã»ã¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã£ã½ãä½¿ã† */
  .call-page {
      max-width: 100%;
      margin: 0;
      padding: 0;
  }

  .call-card {
      border-radius: 0;
      box-shadow: none;
      padding: 0;
  }

  /* ç”»é¢å…¨ä½“ã‚’ä½¿ã†ã‚¨ãƒªã‚¢ï¼ˆã“ã“ã¯ã€ŒèƒŒæ™¯ã€æ‹…å½“ï¼‰ */
  .fullscreen-call {
      position: relative;
      width: 100%;
      height: calc(100vh - 140px);  /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‹ãƒœã‚¿ãƒ³ã¶ã‚“å°‘ã—å¼•ã */
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
  }

  /* ä¸­å¤®ã®ã€Œã‚¹ãƒãƒ›ç”»é¢ã€æ  */
  .call-video-frame {
      position: relative;
      width: min(100%, 420px);   /* PC ã§ã¯ 420px ãã‚‰ã„ã‚’ä¸Šé™ã«ç¸¦é•· */
      aspect-ratio: 9 / 16;      /* ã‚¹ãƒãƒ›ç¸¦ç”»é¢ã®æ¯”ç‡ */
      background: #000;
      overflow: hidden;
  }

  /* ç›¸æ‰‹ã®æ˜ åƒï¼šã‚¹ãƒãƒ›æ ã„ã£ã±ã„ã«è¡¨ç¤º */
  #remoteVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
  }

  /* ç›¸æ‰‹ãŒã„ãªã„ã¨ãã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¹ãƒãƒ›æ ã®ä¸­å¤®ã«ï¼‰ */
  #remoteFallback {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      color: #ccc;
      font-size: 13px;
      background: rgba(0,0,0,0.4);
      padding: 6px 10px;
      border-radius: 999px;
  }

  /* è‡ªåˆ†ã®æ˜ åƒã‚’å³ä¸‹ã«å°ã•ãé‡ã­ã‚‹ï¼ˆã‚¹ãƒãƒ›æ ã®ä¸­ã«é…ç½®ï¼‰ */
  .self-video-wrapper {
      position: absolute;
      right: 8px;
      bottom: 8px;
      width: 30%;
      max-width: 120px;
      aspect-ratio: 9 / 16;
      background: #000;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.8);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  #localVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
  }

  #localFallback {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ddd;
      font-size: 11px;
      padding: 4px;
      text-align: center;
      background: rgba(0,0,0,0.35);
  }

  /* ä¸‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼†ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
  .call-bottom-panel {
      padding: 10px 14px 16px;
      background: #111;
      color: #eee;
  }

  .call-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #ffb2d0;
      display: flex;
      align-items: center;
      gap: 6px;
  }

  .call-title::before {
      content: "ğŸ“";
  }

  .call-subtitle {
      font-size: 11px;
      color: #aaa;
      margin-bottom: 6px;
  }

  .video-status {
      font-size: 11px;
      color: #ccc;
      margin-bottom: 8px;
  }

  .call-buttons-main,
  .call-buttons-toggle {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
  }

  .btn-primary,
  .btn-ghost,
  .btn-danger {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      text-align: center;
      min-width: 110px;
      white-space: nowrap;
  }

  .btn-primary {
      background: var(--pink);
      color: #fff;
  }
  .btn-primary:hover {
      background: var(--pink-strong);
  }

  .btn-ghost {
      border: 1px solid var(--pink);
      color: var(--pink-strong);
      background: #fff;
  }
  .btn-ghost:hover {
      background: var(--pink-light);
  }

  .btn-danger {
      background: #ff6f6f;
      color: #fff;
  }
  .btn-danger:hover {
      background: #ff4a4a;
  }

  @media (max-width: 768px) {
      .fullscreen-call {
          height: calc(100vh - 130px);
      }
      .self-video-wrapper {
          right: 6px;
          bottom: 6px;
          max-width: 110px;
      }
  }
</style>
{% endblock %}

{% block content %}
<div class="call-page">
  <div class="call-card">

    <!-- ç›¸æ‰‹ï¼šã‚¹ãƒãƒ›ç¸¦é•·ãƒ•ãƒ¬ãƒ¼ãƒ ã€è‡ªåˆ†ï¼šå³ä¸‹å°çª“ -->
    <div class="fullscreen-call">
      <div class="call-video-frame">
        <video id="remoteVideo" autoplay playsinline></video>
        <span id="remoteFallback">ã¾ã ç›¸æ‰‹ãŒæ¥ç¶šã—ã¦ã„ã¾ã›ã‚“ã€‚</span>

        <div class="self-video-wrapper">
          <video id="localVideo" autoplay playsinline muted></video>
          <span id="localFallback">ã‚«ãƒ¡ãƒ© / ãƒã‚¤ã‚¯æœªæ¥ç¶š</span>
        </div>
      </div>
    </div>

    <!-- ç”»é¢ä¸‹ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
    <div class="call-bottom-panel">
      <div class="call-title">
        é€šè©±ãƒ«ãƒ¼ãƒ 
      </div>
      <div class="call-subtitle">
        ç›¸æ‰‹ã¨é€šè©±ã—ãŸã„ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚
      </div>

      <div id="localStatus" class="video-status">
        ãƒã‚¤ã‚¯ãƒ»ã‚«ãƒ¡ãƒ©ã¯ã¾ã OFFã§ã™ã€‚
      </div>

      <div class="call-buttons-main">
        <button id="btnStartAudio" class="btn-primary">ğŸ”ˆ éŸ³å£°é€šè©±é–‹å§‹</button>
        <button id="btnStartVideo" class="btn-primary">ğŸ¥ ãƒ“ãƒ‡ã‚ªé€šè©±é–‹å§‹</button>
        <button id="btnHangup" class="btn-danger">ğŸ“´ åˆ‡æ–­</button>
        <a href="{% url 'chat_room' room_id=room.id %}" class="btn-ghost">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã«æˆ»ã‚‹</a>
      </div>

      <div class="call-buttons-toggle">
        <button id="btnToggleMic" class="btn-ghost">ğŸ™ ãƒã‚¤ã‚¯ OFF</button>
        <button id="btnToggleCam" class="btn-ghost">ğŸ“· ã‚«ãƒ¡ãƒ© OFF</button>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // â˜… JS éƒ¨åˆ†ã¯ãã®ã¾ã¾ï¼ˆID ã‚‚å¤‰ãˆã¦ã„ãªã„ã®ã§ã‚³ãƒ”ãƒšã§OKï¼‰
  let localStream = null;
  let pc = null;
  let socket = null;

  let micEnabled = true;
  let camEnabled = true;

  document.addEventListener("DOMContentLoaded", () => {
      const localVideo    = document.getElementById("localVideo");
      const remoteVideo   = document.getElementById("remoteVideo");
      const localStatus   = document.getElementById("localStatus");
      const localFallback = document.getElementById("localFallback");
      const remoteFallback = document.getElementById("remoteFallback");

      const btnStartAudio = document.getElementById("btnStartAudio");
      const btnStartVideo = document.getElementById("btnStartVideo");
      const btnHangup     = document.getElementById("btnHangup");
      const btnToggleMic  = document.getElementById("btnToggleMic");
      const btnToggleCam  = document.getElementById("btnToggleCam");

      const roomId = "{{ room.id }}";

      const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
      const wsUrl = `${wsScheme}://${window.location.host}/ws/call/${roomId}/`;
      console.log("Connecting WebSocket:", wsUrl);
      socket = new WebSocket(wsUrl);

      socket.onopen = () => {
          console.log("WebSocket connected");
      };

      socket.onmessage = async (event) => {
          const msg = JSON.parse(event.data);
          console.log("WebSocket message:", msg);

          const type = msg.event;
          const data = msg.data;

          if (type === "offer") {
              await handleOffer(data);
          } else if (type === "answer") {
              await handleAnswer(data);
          } else if (type === "candidate") {
              await handleCandidate(data);
          } else if (type === "leave") {
              handleRemoteLeave();
          }
      };

      socket.onclose = () => {
          console.log("WebSocket closed");
      };

      socket.onerror = (err) => {
          console.error("WebSocket error:", err);
      };

      function ensurePeerConnection() {
          if (pc) return;

          const config = {
              iceServers: [
                  { urls: "stun:stun.l.google.com:19302" },
              ],
          };

          pc = new RTCPeerConnection(config);

          pc.onicecandidate = (event) => {
              if (event.candidate && socket && socket.readyState === WebSocket.OPEN) {
                  socket.send(JSON.stringify({
                      event: "candidate",
                      data: event.candidate
                  }));
              }
          };

          pc.ontrack = (event) => {
              console.log("ontrack:", event);
              const [remoteStream] = event.streams;
              remoteVideo.srcObject = remoteStream;
              if (remoteFallback) {
                  remoteFallback.style.display = "none";
              }
          };

          pc.onconnectionstatechange = () => {
              console.log("PC state:", pc.connectionState);
          };
      }

      async function startLocalMedia(kind) {
          try {
              if (localStream) {
                  localStream.getTracks().forEach(t => t.stop());
                  localStream = null;
              }

              const constraints = (kind === "video")
                  ? { audio: true, video: true }
                  : { audio: true, video: false };

              localStream = await navigator.mediaDevices.getUserMedia(constraints);

              micEnabled = true;
              camEnabled = constraints.video;

              if (constraints.video) {
                  localVideo.srcObject = localStream;
                  localVideo.style.display = "block";
                  if (localFallback) localFallback.style.display = "none";
                  localStatus.textContent = "ã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯ ON";
              } else {
                  localVideo.srcObject = null;
                  if (localFallback) {
                      localFallback.style.display = "block";
                      localFallback.textContent = "éŸ³å£°é€šè©±ä¸­ï¼ˆæ˜ åƒãªã—ï¼‰";
                  }
                  localStatus.textContent = "ãƒã‚¤ã‚¯ ONï¼ˆæ˜ åƒãªã—ï¼‰";
              }
              updateToggleButtons();

              ensurePeerConnection();
              localStream.getTracks().forEach((track) => {
                  pc.addTrack(track, localStream);
              });

          } catch (err) {
              console.error("getUserMedia error:", err);
              alert("ã‚«ãƒ¡ãƒ© / ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
              localStatus.textContent = "ãƒã‚¤ã‚¯ãƒ»ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
          }
      }

      async function startCall(kind) {
          await startLocalMedia(kind);
          ensurePeerConnection();

          if (!pc) return;
          if (!socket || socket.readyState !== WebSocket.OPEN) {
              alert("ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ç”¨ WebSocket ã«æ¥ç¶šã§ãã¦ã„ã¾ã›ã‚“ã€‚");
              return;
          }

          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          socket.send(JSON.stringify({
              event: "offer",
              data: {
                  sdp: offer.sdp,
                  type: offer.type,
                  mode: kind
              }
          }));
      }

      async function handleOffer(data) {
          console.log("handleOffer", data);

          ensurePeerConnection();

          if (!localStream) {
              const mode = data.mode || "video";
              await startLocalMedia(mode);
          }

          const offer = new RTCSessionDescription({
              type: data.type,
              sdp: data.sdp
          });

          await pc.setRemoteDescription(offer);

          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);

          socket.send(JSON.stringify({
              event: "answer",
              data: {
                  sdp: answer.sdp,
                  type: answer.type
              }
          }));
      }

      async function handleAnswer(data) {
          console.log("handleAnswer", data);
          if (!pc) return;

          const answer = new RTCSessionDescription({
              type: data.type,
              sdp: data.sdp
          });

          await pc.setRemoteDescription(answer);
      }

      async function handleCandidate(candidate) {
          console.log("handleCandidate", candidate);
          if (!pc) return;
          try {
              await pc.addIceCandidate(new RTCIceCandidate(candidate));
          } catch (err) {
              console.error("addIceCandidate error:", err);
          }
      }

      function updateToggleButtons() {
          if (btnToggleMic) {
              btnToggleMic.textContent = micEnabled ? "ğŸ™ ãƒã‚¤ã‚¯ OFF" : "ğŸ™ ãƒã‚¤ã‚¯ ON";
          }
          if (btnToggleCam) {
              btnToggleCam.textContent = camEnabled ? "ğŸ“· ã‚«ãƒ¡ãƒ© OFF" : "ğŸ“· ã‚«ãƒ¡ãƒ© ON";
          }

          if (!micEnabled && !camEnabled) {
              localStatus.textContent = "ãƒã‚¤ã‚¯ãƒ»ã‚«ãƒ¡ãƒ©ã¨ã‚‚ã« OFF ã§ã™ã€‚";
          } else if (!micEnabled && camEnabled) {
              localStatus.textContent = "ã‚«ãƒ¡ãƒ©ã ã‘ ONï¼ˆãƒã‚¤ã‚¯ã¯ãƒŸãƒ¥ãƒ¼ãƒˆï¼‰ã€‚";
          } else if (micEnabled && !camEnabled) {
              localStatus.textContent = "ãƒã‚¤ã‚¯ã ã‘ ONï¼ˆæ˜ åƒãªã—ï¼‰ã€‚";
          } else {
              localStatus.textContent = "ã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯ ONã€‚";
          }
      }

      function toggleMic() {
          if (!localStream) return;
          const audioTracks = localStream.getAudioTracks();
          if (!audioTracks.length) return;

          micEnabled = !micEnabled;
          audioTracks.forEach(track => track.enabled = micEnabled);
          updateToggleButtons();
      }

      function toggleCam() {
          if (!localStream) return;
          const videoTracks = localStream.getVideoTracks();
          if (!videoTracks.length) return;

          camEnabled = !camEnabled;
          videoTracks.forEach(track => track.enabled = camEnabled);

          if (!camEnabled) {
              localVideo.style.display = "none";
              if (localFallback) {
                  localFallback.style.display = "block";
                  localFallback.textContent = "ã‚«ãƒ¡ãƒ© OFF ä¸­";
              }
          } else {
              localVideo.style.display = "block";
              if (localFallback) {
                  localFallback.style.display = "none";
              }
          }
          updateToggleButtons();
      }

      function hangup() {
          if (localStream) {
              localStream.getTracks().forEach(t => t.stop());
              localStream = null;
          }
          if (pc) {
              pc.close();
              pc = null;
          }
          if (localFallback) {
              localFallback.textContent = "ã‚«ãƒ¡ãƒ© / ãƒã‚¤ã‚¯æœªæ¥ç¶š";
              localFallback.style.display = "block";
          }
          if (localVideo) {
              localVideo.srcObject = null;
          }
          localStatus.textContent = "é€šè©±ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚";
          micEnabled = false;
          camEnabled = false;
          updateToggleButtons();

          if (socket && socket.readyState === WebSocket.OPEN) {
              socket.send(JSON.stringify({ event: "leave", data: null }));
          }
      }

      function handleRemoteLeave() {
          if (remoteVideo) {
              remoteVideo.srcObject = null;
          }
          if (remoteFallback) {
              remoteFallback.style.display = "block";
              remoteFallback.textContent = "ç›¸æ‰‹ãŒé€šè©±ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚";
          }
      }

      if (btnStartAudio) {
          btnStartAudio.addEventListener("click", (e) => {
              e.preventDefault();
              startCall("audio");
          });
      }

      if (btnStartVideo) {
          btnStartVideo.addEventListener("click", (e) => {
              e.preventDefault();
              startCall("video");
          });
      }

      if (btnHangup) {
          btnHangup.addEventListener("click", (e) => {
              e.preventDefault();
              hangup();
          });
      }

      if (btnToggleMic) {
          btnToggleMic.addEventListener("click", (e) => {
              e.preventDefault();
              toggleMic();
          });
      }

      if (btnToggleCam) {
          btnToggleCam.addEventListener("click", (e) => {
              e.preventDefault();
              toggleCam();
          });
      }

      const params = new URLSearchParams(window.location.search);
      const initialMode = params.get("mode");
      if (initialMode === "audio") {
          startCall("audio");
      } else if (initialMode === "video") {
          startCall("video");
      } else {
          micEnabled = true;
          camEnabled = false;
          updateToggleButtons();
      }
  });
</script>
{% endblock %}
